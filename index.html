<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PENTAGON 5 VOL.2 2026 - ADMIN SYSTEM</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --sidebar-bg: #0f172a; --active-blue: #3b82f6; --body-bg: #f1f5f9; }
        body { background-color: var(--body-bg); font-family: 'Poppins', sans-serif; overflow-x: hidden; color: #334155; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SIDEBAR */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: white; position: fixed; padding: 30px 20px; display: flex; flex-direction: column; z-index: 1000; transition: all 0.3s ease; }
        .nav-btn { padding: 12px 20px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; color: #94a3b8; font-weight: 600; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--active-blue); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--sidebar-bg); color: white; padding: 10px 14px; border-radius: 8px; border: none; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }

        /* CONTENT */
        .main-content { margin-left: 260px; padding: 30px 40px; min-height: 100vh; filter: blur(5px); transition: filter 0.3s; pointer-events: none; }
        .main-content.logged-in { filter: none; pointer-events: auto; }
        
        .white-panel { background: white; border-radius: 20px; padding: 30px; min-height: 600px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .view-section { display: none; } .view-section.active { display: block; }

        /* STATS CARD */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { border-radius: 15px; padding: 20px; color: white; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .bg-1 { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-2 { background: linear-gradient(135deg, #f43f5e, #e11d48); }
        .bg-3 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-4 { background: linear-gradient(135deg, #f97316, #ea580c); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(3px); }
        .modal-content-box { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popUp 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .tab-btn { padding: 8px 20px; border-radius: 20px; border: none; background: #e2e8f0; color: #64748b; font-weight: 600; margin-right: 5px; font-size: 0.9rem; }
        .tab-btn.active-smp { background: #dbeafe; color: #1e40af; }
        .tab-btn.active-sma { background: #fee2e2; color: #991b1b; }

        /* TOAST & LOADER */
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast-item { background: white; padding: 15px 20px; border-radius: 10px; border-left: 5px solid #3b82f6; box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        /* LOGIN & CUSTOM */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 999999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .login-hidden { display: none !important; }

        .chk-container { display: flex; flex-direction: column; align-items: center; margin: 0 2px; }
        .chk-title { font-size: 0.55rem; font-weight: bold; color: #64748b; margin-bottom: 2px; }
        .custom-chk { display: none; }
        .chk-label { width: 28px; height: 28px; background: #e2e8f0; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: transparent; transition: 0.2s; }
        .custom-chk:checked + .chk-label { background: #10b981; color: white; transform: scale(1.1); }

        .switch-sm { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch-sm input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(14px); }

        @media (max-width: 768px) {
            .sidebar { left: -270px; } .sidebar.active { left: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            .main-content { margin-left: 0; padding: 80px 15px 30px 15px; }
            .mobile-toggle { display: block; }
            .stats-row { grid-template-columns: 1fr 1fr; gap: 10px; }
            .white-panel { padding: 15px; min-height: auto; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card fade-in">
            <div class="mb-4">
                <img src="https://i.imgur.com/BHU3xOr.png" alt="Logo" style="width: 100px; height: auto; margin-bottom: 15px;">
                <h4 class="fw-bold mt-2">LOGIN ADMIN</h4>
                <p class="text-secondary small">PENTAGON 5 VOL.2 2026</p>
            </div>
            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="form-floating mb-3">
                    <input type="password" class="form-control text-center fw-bold" id="password-input" placeholder="Password" style="letter-spacing: 5px;">
                    <label for="password-input">Masukkan Kode Akses</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold rounded-pill shadow-sm">MASUK SISTEM</button>
            </form>
            <div class="mt-4 small text-muted">&copy; TIM IT PENTAGON</div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="fw-bold small text-secondary">MEMUAT DATA...</div>
    </div>

    <div id="toast-box"></div>
    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="bi bi-list fs-4"></i></button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="text-center mb-5 mt-2">
            <img src="https://i.imgur.com/BHU3xOr.png" alt="Logo Sidebar" style="width: 60px; height: auto; margin-bottom: 10px;">
            <h5 class="fw-bold mb-0 text-light">PENTAGON 5</h5>
            <small class="text-white-50">Admin Dashboard</small>
        </div>
        <div class="nav-btn active" id="btn-dash" onclick="switchView('dash')"><i class="bi bi-grid-fill"></i> DASHBOARD</div>
        <div class="nav-btn" id="btn-input" onclick="switchView('input')"><i class="bi bi-people-fill"></i> DATA PESERTA</div>
        <div class="nav-btn" id="btn-validasi" onclick="switchView('validasi')"><i class="bi bi-check-circle-fill"></i> VALIDASI BERKAS</div>
        <div class="nav-btn" id="btn-absensi" onclick="switchView('absensi')"><i class="bi bi-qr-code-scan"></i> ABSENSI</div>
        <button class="nav-btn mt-auto btn-danger border-0 text-start w-100" onclick="logoutSystem()">
            <i class="bi bi-box-arrow-left"></i> LOGOUT
        </button>
    </div>

    <div class="main-content">
        <div class="stats-row">
            <div class="stat-card bg-1"><h6>TOTAL PESERTA (<span id="lbl-tab">SMP</span>)</h6><h2 id="st-total">0</h2></div>
            <div class="stat-card bg-2"><h6>BERKAS LENGKAP</h6><h2 id="st-com">0</h2></div>
            <div class="stat-card bg-3"><h6>SUDAH KIRIM BERKAS</h6><h2 id="st-submit">0</h2></div>
            <div class="stat-card bg-4"><h6>SUDAH HADIR</h6><h2 id="st-absen">0</h2></div>
        </div>

        <div class="white-panel">
            
            <div id="view-dash" class="view-section active text-center pt-3">
                <div class="py-5">
                    <img src="https://i.imgur.com/BHU3xOr.png" alt="Logo" style="width: 150px; margin-bottom: 20px;">
                    <h3 class="fw-bold mt-3">ADMIN CENTER</h3>
                    <p class="text-secondary small mb-4">SELAMAT DATANG DI SISTEM MANAJEMEN PENTAGON 5</p>
                    <div class="d-grid gap-2 col-lg-6 mx-auto">
                        <button class="btn btn-primary rounded-pill shadow-sm py-2" onclick="switchView('input')">INPUT DATA PESERTA</button>
                        <button class="btn btn-dark rounded-pill shadow-sm py-2" onclick="switchView('absensi')"><i class="bi bi-qr-code"></i> SCAN ABSENSI</button>
                    </div>
                </div>
            </div>

            <div id="view-input" class="view-section">
                <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap gap-2">
                    <h5 class="fw-bold m-0"><i class="bi bi-table text-primary"></i> DATA PESERTA</h5>
                    <button class="btn btn-primary btn-sm rounded-pill shadow-sm px-3" onclick="tambahPeserta()"><i class="bi bi-plus-lg"></i> TAMBAH BARU</button>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-12 col-md-4">
                        <div class="d-flex gap-1">
                            <button class="tab-btn active-smp" id="tab-in-smp" onclick="setTab('SMP')">SMP</button>
                            <button class="tab-btn" id="tab-in-sma" onclick="setTab('SMA')">SMA</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-8">
                        <div class="input-group">
                            <input type="text" id="cari-sekolah" class="form-control" placeholder="Cari Nama Sekolah / Kode..." onkeyup="renderAll()">
                            <button class="btn btn-warning fw-bold text-white" onclick="rapikanUrutanConfirm()" title="Rapikan Nomor Urut"><i class="bi bi-sort-numeric-down"></i> RAPIKAN NO. URUT</button>
                        </div>
                    </div>
                </div>

                <div class="d-flex align-items-center justify-content-between mb-3 bg-light p-2 rounded flex-wrap gap-2">
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" id="chk-hide-absen" onchange="renderAll()" checked>
                        <label class="form-check-label small fw-bold text-secondary" for="chk-hide-absen">Sembunyikan Yang Sudah Hadir</label>
                    </div>
                    <div class="d-flex gap-1 align-items-center">
                        <button class="btn btn-success btn-sm fw-bold" onclick="exportExcel()" title="Export Excel"><i class="bi bi-file-excel"></i> DATA</button>
                        <button class="btn btn-danger btn-sm fw-bold" onclick="exportPDFList()" title="Export PDF"><i class="bi bi-file-pdf"></i> DATA</button>
                        <div class="vr mx-2"></div>
                        <button onclick="downloadRekapTMExcel()" class="btn btn-outline-success btn-sm fw-bold" title="Excel TM"><i class="bi bi-file-earmark-spreadsheet"></i> TM</button>
                        <button onclick="downloadRekapTMPDF()" class="btn btn-outline-danger btn-sm fw-bold" title="PDF TM"><i class="bi bi-file-earmark-pdf"></i> TM</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle" style="min-width: 700px;">
                        <thead class="table-light small">
                            <tr>
                                <th width="35%">SEKOLAH & STATUS</th>
                                <th width="15%" class="text-center">NO. TAMPIL</th>
                                <th width="20%">KODE AKSES</th>
                                <th width="30%" class="text-center">KONTROL ADMIN</th>
                            </tr>
                        </thead>
                        <tbody id="body-input" class="small"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-validasi" class="view-section">
                <div class="d-flex justify-content-between mb-4 align-items-center flex-wrap gap-2">
                    <h5 class="fw-bold m-0 text-primary"><i class="bi bi-patch-check-fill"></i> VALIDASI BERKAS</h5>
                    <div class="d-flex gap-2">
                         <button class="btn btn-danger btn-sm fw-bold shadow-sm" onclick="downloadRekapSimple()"><i class="bi bi-file-earmark-pdf-fill"></i> PDF REKAP PENGIRIMAN</button>
                        <button class="btn btn-secondary btn-sm fw-bold shadow-sm" onclick="exportPDFRekap()"><i class="bi bi-printer-fill"></i> PDF VALIDASI (ADMIN)</button>
                    </div>
                </div>
                
                <div class="row g-2 mb-3">
                    <div class="col-12 col-md-4">
                        <div class="d-flex gap-1">
                            <button class="tab-btn active-smp" id="tab-val-smp" onclick="setTab('SMP')">SMP</button>
                            <button class="tab-btn" id="tab-val-sma" onclick="setTab('SMA')">SMA</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-8">
                        <input type="text" id="cari-validasi" class="form-control" placeholder="Cari Nama Sekolah di Validasi..." onkeyup="renderTableValidasi()">
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle border" style="min-width: 900px;">
                        <thead class="table-dark small">
                            <tr>
                                <th width="20%">SEKOLAH</th>
                                <th width="15%" class="text-center">TERIMA BERKAS</th>
                                <th width="30%" class="text-center">CHECKLIST VALIDASI</th>
                                <th width="15%">CATATAN</th>
                                <th width="10%" class="text-center">STATUS</th>
                                <th width="10%" class="text-center">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="body-validasi" class="small"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-absensi" class="view-section">
                <div class="row">
                    <div class="col-md-5 mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-camera-video-fill text-primary"></i> SCANNER</h5>
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-primary btn-sm flex-fill shadow-sm" onclick="startScanner()" id="btn-start-cam"><i class="bi bi-power"></i> ON</button>
                            <button class="btn btn-danger btn-sm flex-fill shadow-sm" onclick="stopScanner()" id="btn-stop-cam" disabled><i class="bi bi-stop-circle"></i> OFF</button>
                        </div>
                        <div id="qr-reader" class="mb-3 shadow-sm border bg-dark" style="min-height: 250px; background: #000; border-radius: 10px;"></div>
                        <div class="alert alert-info small"><i class="bi bi-info-circle"></i> Arahkan kamera ke QR Code peserta.</div>
                    </div>
                    <div class="col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0">LOG AKTIVITAS SCAN</h5>
                            <button class="btn btn-outline-danger btn-sm" onclick="resetAbsenHarian()">Bersihkan Log</button>
                        </div>
                        <div class="table-responsive border rounded p-2" style="height: 400px; overflow-y: auto; background: #f8fafc;">
                            <table class="table table-sm table-striped small align-middle">
                                <thead class="table-dark"><tr><th>WAKTU</th><th>SEKOLAH</th><th>STATUS</th><th class="text-center">AKSI</th></tr></thead>
                                <tbody id="log-absen-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="modal-input">
        <div class="modal-content-box">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold">FORMULIR PESERTA <span id="lbl-form-tingkat" class="badge bg-primary"></span></h5>
                <button class="btn-close" onclick="closeModal('modal-input')"></button>
            </div>
            <form id="form-peserta">
                <input type="hidden" id="in-id-edit"> 
                <input type="hidden" id="in-tingkat">
                <div class="mb-2">
                    <label class="small fw-bold text-secondary">NAMA SEKOLAH</label>
                    <input type="text" id="in-sekolah" class="form-control" placeholder="Contoh: SMPN 1 BEKASI" required>
                </div>
                <div class="mb-2">
                    <label class="small fw-bold text-secondary">EMAIL OFFICIAL</label>
                    <input type="email" id="in-email" class="form-control" placeholder="email@sekolah.com">
                </div>
                <div class="mb-2">
                    <label class="small fw-bold text-secondary">WHATSAPP BINDAMPING</label>
                    <input type="tel" id="in-wa" class="form-control" placeholder="08xxx" required>
                </div>
                <div class="mb-4">
                    <label class="small fw-bold text-secondary">NAMA BINDAMPING</label>
                    <input type="text" id="in-b1" class="form-control mb-1" placeholder="Nama Bindamping 1">
                    <input type="text" id="in-b2" class="form-control" placeholder="Nama Bindamping 2">
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold py-2">SIMPAN DATA</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-show-qr">
        <div class="modal-content-box text-center">
            <h5 class="fw-bold mb-1" id="qr-title">SEKOLAH</h5>
            <p class="text-muted small mb-3" id="qr-sub">KODE</p>
            <div id="qr-display" class="mb-3 d-flex justify-content-center"></div> 
            <button class="btn btn-primary w-100 mb-2 fw-bold" onclick="downloadQR()"><i class="bi bi-download"></i> DOWNLOAD GAMBAR</button>
            <button class="btn btn-outline-secondary w-100" onclick="closeModal('modal-show-qr')">TUTUP</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-wa">
        <div class="modal-content-box bg-white">
            <div class="d-flex justify-content-between mb-3 text-success">
                <h5 class="fw-bold"><i class="bi bi-whatsapp"></i> KIRIM PESAN MANUAL</h5>
                <button class="btn-close" onclick="closeModal('modal-wa')"></button>
            </div>
            <div class="alert alert-warning small py-2 mb-3"><i class="bi bi-exclamation-triangle-fill"></i> Hindari spam! Kirim manual melalui aplikasi WA.</div>
            <label class="small fw-bold text-secondary">NOMOR TUJUAN</label>
            <div class="input-group mb-3">
                <input type="text" id="wa-num" class="form-control fw-bold border-success text-dark" readonly>
                <button class="btn btn-outline-success" type="button" onclick="copyInput('wa-num')"><i class="bi bi-copy"></i> SALIN</button>
            </div>
            <label class="small fw-bold text-secondary">ISI PESAN</label>
            <textarea id="wa-msg" class="form-control border-success mb-2" rows="6"></textarea>
            <button onclick="copyInput('wa-msg')" class="btn btn-success w-100 fw-bold mb-2"><i class="bi bi-clipboard-check"></i> SALIN PESAN</button>
            <hr>
            <a id="btn-open-wa-manual" href="#" target="_blank" class="btn btn-outline-dark w-100 btn-sm"><i class="bi bi-box-arrow-up-right"></i> Buka WhatsApp Web/App</a>
        </div>
    </div>

    <div class="modal-overlay" id="modal-scan-result" style="display: none; z-index: 2100;">
        <div class="modal-content-box text-center p-4">
            <div class="mb-3 text-success"><i class="bi bi-check-circle-fill" style="font-size: 5rem;"></i></div>
            <h2 class="fw-bold mb-2">SCAN BERHASIL!</h2>
            <h4 id="scan-sekolah" class="text-primary fw-bold mb-4 border-bottom pb-3">NAMA SEKOLAH</h4>
            <div class="alert alert-success">Peserta telah tercatat hadir dalam sistem.</div>
            <button type="button" class="btn btn-lg btn-primary w-100 shadow fw-bold" onclick="tutupModalScan()">OK, LANJUT SCAN (ENTER)</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI UTAMA ---
        const APP_PASSWORD = "admin123";
        const API_URL = "https://script.google.com/macros/s/AKfycbxnFon8h-pVczWlzfF2Ccl4aRMP6TO5cOmn23NbyDMmyv4-qGeyPXLQWMQh7T76SxiF/exec"; 
        
        let db = [];
        let html5QrcodeScanner = null;
        let currentTab = 'SMP';

        window.onload = function() {
            const isLogged = sessionStorage.getItem('ptg_login');
            if(isLogged === 'true') {
                document.getElementById('login-overlay').classList.add('login-hidden');
                document.querySelector('.main-content').classList.add('logged-in');
            }
            document.getElementById('loader').style.display = 'none';
            fetchData();
        };

        function handleLogin(e) {
            e.preventDefault();
            const input = document.getElementById('password-input').value;
            if(input === APP_PASSWORD) {
                sessionStorage.setItem('ptg_login', 'true');
                document.getElementById('login-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-overlay').classList.add('login-hidden');
                    document.querySelector('.main-content').classList.add('logged-in');
                    toast("Berhasil Login Admin", "success");
                }, 500);
            } else { alert("PASSWORD SALAH!"); document.getElementById('password-input').value = ''; }
        }

        function logoutSystem() {
            if(confirm("Keluar dari sistem admin?")) { sessionStorage.removeItem('ptg_login'); location.reload(); }
        }

        async function fetchData() {
            try {
                document.getElementById('loader').style.display = 'flex';
                const res = await fetch(API_URL);
                const json = await res.json();
                if(json.data || Array.isArray(json)) {
                    db = json.data || json;
                    db.forEach(x => { 
                        if(typeof x.absen === 'undefined') x.absen = false;
                        if(typeof x.absen_tm === 'undefined') x.absen_tm = false;
                        if(typeof x.is_submitted === 'undefined') x.is_submitted = false; 
                    });
                    renderAll();
                    if(sessionStorage.getItem('ptg_login') === 'true') toast("Data Terbaru Dimuat");
                }
            } catch (error) {
                console.log("Menggunakan data lokal/cache");
            } finally { document.getElementById('loader').style.display = 'none'; }
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').style.display = document.querySelector('.sidebar').classList.contains('active') ? 'block' : 'none';
        }

        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.getElementById('btn-'+v).classList.add('active');
            if(window.innerWidth <= 768) toggleSidebar();
            if(v !== 'absensi') stopScanner();
            renderAll();
        }

        function setTab(t) {
            currentTab = t;
            ['tab-in-smp', 'tab-in-sma', 'tab-val-smp', 'tab-val-sma'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.className = 'tab-btn';
                    if(id.includes(t.toLowerCase())) el.className = t === 'SMP' ? 'tab-btn active-smp' : 'tab-btn active-sma';
                }
            });
            renderAll();
        }

        function renderAll() { 
            renderTableInput(); 
            renderTableValidasi(); 
            updateStats(); 
        }

        function updateStats() {
            if(!db) return;
            document.getElementById('lbl-tab').innerText = currentTab;
            const list = db.filter(x => x.tingkat === currentTab);
            document.getElementById('st-total').innerText = list.length;
            document.getElementById('st-com').innerText = list.filter(x => x.v_status === 'LENGKAP').length;
            document.getElementById('st-submit').innerText = list.filter(x => x.is_submitted).length; 
            document.getElementById('st-absen').innerText = list.filter(x => x.absen).length;
        }

        function renderTableInput() {
            const tbody = document.getElementById('body-input');
            const key = document.getElementById('cari-sekolah').value.toUpperCase();
            const hideAbsen = document.getElementById('chk-hide-absen').checked;
            
            let list = db.filter(x => x.tingkat === currentTab && 
                (!hideAbsen || !x.absen) && 
                (x.sekolah.toUpperCase().includes(key) || (x.kode && x.kode.toUpperCase().includes(key))));
            
            list.sort((a, b) => {
                const valA = (a.tampil === '-' || !a.tampil) ? 9999 : parseInt(a.tampil);
                const valB = (b.tampil === '-' || !b.tampil) ? 9999 : parseInt(b.tampil);
                return valA - valB;
            });

            if(list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted bg-light">Data tidak ditemukan / Semua sudah hadir.</td></tr>`;
                return;
            }

            const htmlRows = list.map(x => {
                const rowClass = x.absen ? 'table-success fade-in' : 'fade-in';
                const statusBadge = x.absen ? '<span class="badge bg-success"><i class="bi bi-check"></i> HADIR</span>' : '';
                let btnTMClass = x.absen_tm ? 'btn-primary' : 'btn-outline-secondary';
                let btnTMIcon = x.absen_tm ? '<i class="bi bi-check-lg"></i>' : 'TM';
                let labelTM = x.absen_tm ? '<span class="badge bg-primary ms-1" style="font-size:0.6rem;">TM OK</span>' : '';

                return `
                <tr class="${rowClass}">
                    <td class="fw-bold">${x.sekolah} <br>${statusBadge} ${labelTM}</td>
                    <td class="text-center"><span class="badge ${x.tampil==='-'?'bg-secondary':'bg-primary'} fs-6">${x.tampil}</span></td>
                    <td class="font-monospace text-muted">${x.kode||'-'}</td>
                    <td class="text-center text-nowrap">
                        <button onclick="toggleTM(${x.id})" class="btn btn-sm ${btnTMClass} rounded-circle me-1">${btnTMIcon}</button>
                        <button onclick="editDataPeserta(${x.id})" class="btn btn-sm btn-warning text-white rounded-circle"><i class="bi bi-pencil-square"></i></button>
                        <button onclick="editUndian(${x.id})" class="btn btn-sm btn-outline-primary rounded-circle"><i class="bi bi-123"></i></button>
                        <button class="btn btn-sm btn-dark rounded-circle" onclick="showQR(${x.id})"><i class="bi bi-qr-code"></i></button>
                        <button class="btn btn-sm btn-success rounded-circle" onclick="kirimInfoPeserta(${x.id})"><i class="bi bi-whatsapp"></i></button>
                        <button onclick="hapusData(${x.id})" class="btn btn-sm btn-outline-danger rounded-circle"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');

            tbody.innerHTML = htmlRows;
        }

        // --- UPDATE: RENDER TABLE DENGAN DROPDOWN STATUS ---
        function renderTableValidasi() {
            const tbody = document.getElementById('body-validasi'); 
            const searchKey = document.getElementById('cari-validasi').value.toUpperCase();
            
            let list = db.filter(x => x.tingkat === currentTab && x.sekolah.toUpperCase().includes(searchKey));
            
            list.sort((a, b) => {
                const valA = (a.tampil === '-' || !a.tampil) ? 9999 : parseInt(a.tampil);
                const valB = (b.tampil === '-' || !b.tampil) ? 9999 : parseInt(b.tampil);
                return valA - valB;
            });

            if(list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted bg-light">Sekolah tidak ditemukan.</td></tr>`;
                return;
            }

            const htmlRows = list.map(x => {
                const mkChk = (col, label) => `<div class="chk-container"><div class="chk-title">${label}</div><input type="checkbox" id="${col}_${x.id}" class="custom-chk" ${x['v_'+col]?'checked':''}><label for="${col}_${x.id}" class="chk-label"><i class="bi bi-check-lg"></i></label></div>`;
                
                const toggleHTML = `
                <label class="switch-sm">
                  <input type="checkbox" onchange="toggleBerkasMasuk(${x.id}, this)" ${x.is_submitted ? 'checked' : ''}>
                  <span class="slider"></span>
                </label>
                <div class="small fw-bold mt-1 ${x.is_submitted?'text-success':'text-secondary'}">${x.is_submitted?'SUDAH':'BELUM'}</div>
                `;

                // DROPDOWN LOGIC
                const currentStatus = x.v_status || 'BELUM LENGKAP';
                const selectStatus = `
                    <select id="status_${x.id}" class="form-select form-select-sm fw-bold ${currentStatus === 'LENGKAP' ? 'text-success border-success' : 'text-danger border-danger'}" style="font-size: 0.8rem;">
                        <option value="BELUM LENGKAP" ${currentStatus === 'BELUM LENGKAP' ? 'selected' : ''}>BELUM LENGKAP</option>
                        <option value="LENGKAP" ${currentStatus === 'LENGKAP' ? 'selected' : ''}>LENGKAP (OK)</option>
                        <option value="REVISI" ${currentStatus === 'REVISI' ? 'selected' : ''}>PERLU REVISI</option>
                    </select>
                `;

                return `
                <tr class="fade-in">
                    <td class="fw-bold small text-nowrap">
                        <span class="badge bg-secondary me-1" style="font-size:0.7em">${x.tampil}</span> ${x.sekolah}
                        <div class="mt-1 d-flex gap-1">
                            <button onclick="cariDiDrive('${x.sekolah}')" class="btn btn-sm btn-warning text-dark py-0 px-2 shadow-sm" style="font-size: 0.65rem;"><i class="bi bi-search"></i> DRIVE</button>
                            <button onclick="checkAllBerkas(${x.id})" class="btn btn-sm btn-outline-secondary py-0 px-2" style="font-size: 0.65rem;">SET ALL</button>
                        </div>
                    </td>
                    <td class="text-center bg-light border-start border-end">
                        ${toggleHTML}
                    </td>
                    <td><div class="d-flex justify-content-center gap-1">${mkChk('lkbbt','LKBT')} ${mkChk('maket','MKT')} ${mkChk('dance','DNC')} ${mkChk('ios','IOS')} ${mkChk('poster','POS')}</div></td>
                    <td><input type="text" id="note_${x.id}" class="form-control form-control-sm" value="${x.v_note||'-'}" placeholder="Catatan..."></td>
                    <td class="text-center" width="15%">${selectStatus}</td>
                    <td class="text-center text-nowrap">
                        <div class="btn-group">
                            <button onclick="simpanValidasi(${x.id})" class="btn btn-sm btn-primary" title="Simpan"><i class="bi bi-floppy"></i></button>
                            <button onclick="setupWA(${x.id}, 'validation')" class="btn btn-sm btn-success" title="WA"><i class="bi bi-whatsapp"></i></button>
                            <button onclick="cetakSurat(${x.id})" class="btn btn-sm btn-danger" title="Print"><i class="bi bi-file-pdf"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');

            tbody.innerHTML = htmlRows;
        }

        function toggleBerkasMasuk(id, el) {
            const idx = db.findIndex(x => x.id == id);
            if(idx >= 0) {
                db[idx].is_submitted = el.checked;
                renderTableValidasi(); 
                updateStats();
                if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'update_submitted', id:id, status: db[idx].is_submitted})});
            }
        }

        function downloadRekapSimple() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const list = db.filter(x => x.tingkat === currentTab);
            
            list.sort((a, b) => ((a.tampil === '-' ? 999 : parseInt(a.tampil)) - (b.tampil === '-' ? 999 : parseInt(b.tampil))));

            const notSubmitted = list.filter(x => !x.is_submitted);
            const submitted = list.filter(x => x.is_submitted);

            let finalY = 20;

            doc.setFontSize(14);
            doc.text(`STATUS PENGIRIMAN BERKAS - ${currentTab}`, 105, finalY, { align: "center" });
            doc.setFontSize(10);
            doc.text(`Per: ${new Date().toLocaleString('id-ID')}`, 105, finalY + 7, { align: "center" });
            finalY += 15;

            doc.setFontSize(11);
            doc.setTextColor(220, 38, 38); 
            doc.text(`BELUM MENYERAHKAN BERKAS (${notSubmitted.length})`, 14, finalY);
            doc.setTextColor(0,0,0);

            if (notSubmitted.length > 0) {
                 doc.autoTable({
                    startY: finalY + 2,
                    head: [['No', 'Nama Sekolah']], 
                    body: notSubmitted.map((x, i) => [i + 1, x.sekolah]), 
                    headStyles: { fillColor: [220, 38, 38] },
                    theme: 'grid',
                    columnStyles: { 0: { halign: 'center', cellWidth: 15 } }
                });
                finalY = doc.lastAutoTable.finalY + 15;
            } else {
                doc.setFontSize(10);
                doc.text("NIHIL (Semua sudah menyerahkan)", 14, finalY + 8);
                finalY += 20;
            }

            doc.setFontSize(11);
            doc.setTextColor(22, 163, 74); 
            doc.text(`SUDAH MENYERAHKAN BERKAS (${submitted.length})`, 14, finalY);
            doc.setTextColor(0,0,0);

            if (submitted.length > 0) {
                doc.autoTable({
                    startY: finalY + 2,
                    head: [['No', 'Nama Sekolah']], 
                    body: submitted.map((x, i) => [i + 1, x.sekolah]), 
                    headStyles: { fillColor: [22, 163, 74] },
                    theme: 'grid',
                    columnStyles: { 0: { halign: 'center', cellWidth: 15 } }
                });
            }

            doc.save(`Rekap_Berkas_${currentTab}.pdf`);
        }

        function checkAllBerkas(id) {
            ['lkbbt','maket','dance','ios','poster'].forEach(c => {
                const el = document.getElementById(`${c}_${id}`);
                if(el) el.checked = true;
            });
        }

        // --- UPDATE: SIMPAN VALIDASI MANUAL ---
        function simpanValidasi(id) {
            const idx = db.findIndex(x => x.id == id);
            const cols = ['lkbbt','maket','dance','ios','poster'];
            
            cols.forEach(c => { const val = document.getElementById(`${c}_${id}`).checked ? 1 : 0; db[idx]['v_'+c] = val; });
            
            db[idx].v_note = document.getElementById(`note_${id}`).value;
            
            // AMBIL STATUS DARI DROPDOWN
            const manualStatus = document.getElementById(`status_${id}`).value;
            db[idx].v_status = manualStatus;
            
            renderTableValidasi(); updateStats(); toast("Validasi Tersimpan");
            if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'validate', id:id, ...db[idx], is_submitted: db[idx].is_submitted})});
        }

        function cariDiDrive(namaSekolah) {
            const parentID = "1nyDKvIUNTCuU7xuINVjojZ3gVjzZ76GYQ64HeCrwNFgAciJvRK-JD3UN-YBSMlETRzcP7617";
            const query = `parent:${parentID} "${namaSekolah}"`;
            window.open(`https://drive.google.com/drive/search?q=${encodeURIComponent(query)}`, '_blank');
        }

        function startScanner() {
            if(html5QrcodeScanner) return;
            document.getElementById('btn-start-cam').disabled = true;
            document.getElementById('btn-stop-cam').disabled = false;
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, onScanSuccess)
            .catch(err => { toast("Gagal membuka kamera: " + err, "danger"); stopScanner(); });
        }

        function stopScanner() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear(); html5QrcodeScanner = null;
                    document.getElementById('btn-start-cam').disabled = false;
                    document.getElementById('btn-stop-cam').disabled = true;
                });
            }
        }

        function onScanSuccess(decodedText) {
            const cleanCode = decodedText.trim().toUpperCase();
            const idx = db.findIndex(x => x.kode === cleanCode);
            if(idx >= 0) {
                if(db[idx].absen) { toast(`${db[idx].sekolah} SUDAH ABSEN!`, 'warning'); } else {
                    db[idx].absen = true; new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    addLogAbsen(db[idx].id, db[idx].sekolah, "BERHASIL");
                    document.getElementById('scan-sekolah').innerText = db[idx].sekolah;
                    openModal('modal-scan-result');
                    if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'attendance', id:db[idx].id, status: true})});
                    renderTableInput(); updateStats();
                }
                html5QrcodeScanner.pause();
            } else { toast(`Kode ${cleanCode} Tidak Dikenal`, 'danger'); }
        }

        function tutupModalScan() { closeModal('modal-scan-result'); if (html5QrcodeScanner) html5QrcodeScanner.resume(); }

        function addLogAbsen(id, nama, status) {
            const tbody = document.getElementById('log-absen-body'); 
            const now = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const rowId = `log_${Date.now()}`;
            tbody.insertAdjacentHTML('afterbegin', `<tr id="${rowId}"><td>${now}</td><td class="fw-bold">${nama}</td><td class="status-cell"><span class="badge bg-success">${status}</span></td><td class="text-center"><button class="btn btn-sm btn-outline-danger py-0" onclick="batalAbsen(${id}, '${rowId}')">Batal</button></td></tr>`);
        }

        function batalAbsen(id, rowElemId) {
            if(!confirm("Batalkan kehadiran ini?")) return;
            const idx = db.findIndex(x => x.id == id);
            if(idx >= 0) {
                db[idx].absen = false; renderTableInput(); updateStats();
                document.getElementById(rowElemId).querySelector('.status-cell').innerHTML = '<span class="badge bg-secondary">DIBATALKAN</span>';
                if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'attendance', id:id, status: false})});
            }
        }
        
        function resetAbsenHarian() { if(confirm("Hapus semua log tampilan?")) document.getElementById('log-absen-body').innerHTML = ''; }

        function tambahPeserta() {
            document.getElementById('form-peserta').reset();
            document.getElementById('in-id-edit').value = "";
            document.getElementById('in-tingkat').value = currentTab;
            document.getElementById('lbl-form-tingkat').innerText = currentTab; 
            openModal('modal-input');
        }

        function editDataPeserta(id) {
            const data = db.find(x => x.id == id);
            if(!data) return;
            document.getElementById('in-id-edit').value = id; 
            document.getElementById('in-tingkat').value = data.tingkat;
            document.getElementById('in-sekolah').value = data.sekolah;
            document.getElementById('in-email').value = data.email || '';
            document.getElementById('in-wa').value = data.wa;
            document.getElementById('in-b1').value = data.b1 || '';
            document.getElementById('in-b2').value = data.b2 || '';
            document.getElementById('lbl-form-tingkat').innerText = data.tingkat + " (EDIT)"; 
            openModal('modal-input');
        }

        document.getElementById('form-peserta').addEventListener('submit', function(e){
            e.preventDefault();
            const idEdit = document.getElementById('in-id-edit').value;
            const payload = {
                sekolah: document.getElementById('in-sekolah').value.toUpperCase(), email: document.getElementById('in-email').value,
                wa: document.getElementById('in-wa').value, b1: document.getElementById('in-b1').value, b2: document.getElementById('in-b2').value
            };
            if (idEdit) {
                const idx = db.findIndex(x => x.id == idEdit);
                if(idx >= 0) {
                    Object.assign(db[idx], payload); toast("Data Diperbarui");
                    if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'update_data', id:idEdit, ...payload})});
                }
            } else {
                const newData = { action: 'add', id: Date.now(), tingkat: document.getElementById('in-tingkat').value, tampil:'-', kode:'-', v_status:'BELUM LENGKAP', is_submitted: false, ...payload };
                db.push(newData); toast("Data Ditambahkan");
                if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(newData)});
            }
            closeModal('modal-input'); renderAll();
        });

        function hapusData(id) {
            if(!confirm("Yakin hapus data ini? Data lain akan otomatis diurutkan ulang.")) return;
            db = db.filter(x => x.id != id);
            if(!API_URL.includes("GANTI")) {
                fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'delete', id:id})});
            }
            rapikanUrutan();
            toast("Data dihapus & urutan dirapikan.", "success");
        }

        function editUndian(id) {
            const dataCurrent = db.find(x => x.id == id);
            if (!dataCurrent) return;

            let valStr = prompt(`Ubah No Tampil untuk ${dataCurrent.sekolah}.\n(Jika nomor bentrok, nomor lama akan otomatis tergeser +1)`, dataCurrent.tampil !== '-' ? dataCurrent.tampil : '');
            
            if (valStr === null) return; 
            if (valStr.trim() === "") return; 
            
            const newVal = parseInt(valStr);
            if (isNaN(newVal)) {
                alert("Harap masukkan angka yang valid!");
                return;
            }

            const tingkat = dataCurrent.tingkat;

            function geserNomor(nomorCek) {
                let bentrokIdx = db.findIndex(x => x.tingkat === tingkat && parseInt(x.tampil) === nomorCek && x.id !== id);
                if (bentrokIdx !== -1) {
                    geserNomor(nomorCek + 1); 
                    const nextNum = nomorCek + 1;
                    db[bentrokIdx].tampil = nextNum.toString();
                    db[bentrokIdx].kode = generateKode(db[bentrokIdx].tingkat, nextNum.toString());
                    simpanKeServer(db[bentrokIdx]);
                }
            }

            geserNomor(newVal);

            const idx = db.findIndex(x => x.id == id);
            db[idx].tampil = newVal.toString();
            db[idx].kode = generateKode(db[idx].tingkat, newVal.toString());

            simpanKeServer(db[idx]);
            renderAll();
            toast(`Berhasil ubah nomor. Klik 'RAPIKAN NO. URUT' jika ada yang bolong.`, "info");
        }

        function rapikanUrutanConfirm() {
            if(confirm("Yakin ingin merapikan nomor urut? \nSemua peserta akan diurutkan ulang dari 1 sampai akhir berdasarkan urutan saat ini.")) {
                rapikanUrutan();
                toast("Nomor urut berhasil dirapikan!", "success");
            }
        }

        function rapikanUrutan() {
            let list = db.filter(x => x.tingkat === currentTab && x.tampil !== '-' && x.tampil);
            list.sort((a,b) => parseInt(a.tampil) - parseInt(b.tampil));

            list.forEach((item, index) => {
                const newNum = index + 1;
                if (parseInt(item.tampil) !== newNum) {
                    item.tampil = newNum.toString();
                    item.kode = generateKode(item.tingkat, item.tampil);
                    simpanKeServer(item); 
                }
            });
            renderAll();
        }

        function generateKode(tingkat, numStr) {
            return `PTG-${tingkat === 'SMP' ? 'G' : 'T'}-${numStr.padStart(3, '0')}`;
        }

        function simpanKeServer(item) {
            if (!API_URL.includes("GANTI")) {
                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'edit',
                        id: item.id,
                        tampil: item.tampil,
                        kode: item.kode
                    })
                });
            }
        }

        function toggleTM(id) {
            const idx = db.findIndex(x => x.id == id);
            if (idx >= 0) {
                db[idx].absen_tm = !db[idx].absen_tm;
                renderTableInput(); toast(`${db[idx].sekolah} - TM OK`, "info");
                if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'update_tm', id:db[idx].id, status: db[idx].absen_tm})});
            }
        }

        function exportPDFList() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            let list = db.filter(x => x.tingkat === currentTab);
            list.sort((a,b)=> ((a.tampil==='-'?9999:parseInt(a.tampil)) - (b.tampil==='-'?9999:parseInt(b.tampil))));
            doc.text(`DATA PESERTA ${currentTab}`, 14, 20);
            doc.autoTable({ startY: 30, head: [['No', 'Sekolah', 'No. Undian', 'Kode']], body: list.map((x,i) => [i+1, x.sekolah, x.tampil, x.kode]) });
            doc.save(`Data_Peserta_${currentTab}.pdf`);
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(db.filter(x => x.tingkat === currentTab).map((x,i)=>({No:i+1, Sekolah:x.sekolah, Undian:x.tampil, Kode:x.kode, Status:x.v_status})));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "Data_Peserta.xlsx");
        }

        function downloadRekapTMExcel() {
            const dataHadir = db.filter(x => x.absen_tm === true);
            const ws = XLSX.utils.json_to_sheet(dataHadir.map((x, i) => ({ "No": i + 1, "Sekolah": x.sekolah, "Tingkat": x.tingkat, "Kode": x.kode, "Status": "HADIR TM" })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Rekap TM"); XLSX.writeFile(wb, `REKAP_TM_${Date.now()}.xlsx`);
        }

        function downloadRekapTMPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const dataHadir = db.filter(x => x.absen_tm === true);
            doc.text("REKAP ABSENSI TECHNICAL MEETING", 105, 20, { align: "center" });
            doc.autoTable({ startY: 30, head: [['No', 'Sekolah', 'Tingkat', 'Kode', 'Status']], body: dataHadir.map((x, i) => [i + 1, x.sekolah, x.tingkat, x.kode, "HADIR"]) });
            doc.save(`REKAP_TM_${Date.now()}.pdf`);
        }

        function exportPDFRekap() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const list = db.filter(x => x.tingkat === currentTab);
            list.sort((a, b) => ((a.tampil === '-' ? 999 : parseInt(a.tampil)) - (b.tampil === '-' ? 999 : parseInt(b.tampil))));
            doc.text(`REKAP VALIDASI ${currentTab}`, 14, 20);
            doc.autoTable({ startY:30, head:[['No Undian', 'Sekolah','Trm Berkas','LKB','MKT','DNC','IOS','POS','Status']], body:list.map(x=>[x.tampil, x.sekolah, x.is_submitted?'OK':'-', x.v_lkbbt?'V':'-', x.v_maket?'V':'-', x.v_dance?'V':'-', x.v_ios?'V':'-', x.v_poster?'V':'-', x.v_status]) });
            doc.save('Rekap_Validasi.pdf');
        }

        function cetakSurat(id) {
            const x = db.find(d => d.id == id); if (!x) return;
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("LEMBAR VALIDASI PESERTA", 105, 20, { align: "center" });
            doc.setTextColor(0, 0, 0); doc.setFontSize(11); doc.text(`Sekolah : ${x.sekolah}`, 20, 60); doc.text(`Kode : ${x.kode}`, 20, 68);
            doc.autoTable({ startY: 80, head: [['JENIS BERKAS', 'STATUS']], body: [ ["PENGIRIMAN BERKAS", x.is_submitted ? "SUDAH DITERIMA" : "BELUM DITERIMA"], ["LKBBT", x.v_lkbbt?"LENGKAP":"BELUM"], ["Maket", x.v_maket?"LENGKAP":"BELUM"], ["Dance", x.v_dance?"LENGKAP":"BELUM"], ["IOS", x.v_ios?"LENGKAP":"BELUM"], ["Poster", x.v_poster?"LENGKAP":"BELUM"] ] });
            doc.save(`Validasi_${x.sekolah}.pdf`);
        }

        function showQR(id) {
            const x = db.find(d => d.id == id); if(!x || x.kode === '-') return;
            document.getElementById('qr-title').innerText = x.sekolah;
            document.getElementById('qr-sub').innerText = x.kode;
            const c = document.getElementById('qr-display'); c.innerHTML = '';
            new QRCode(c, { text: x.kode, width: 200, height: 200 }); openModal('modal-show-qr');
        }

        function kirimInfoPeserta(id) {
            const x = db.find(d => d.id == id); if(!x) return;
            const canvas = document.createElement('canvas'); canvas.width = 800; canvas.height = 1000; const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#0f172a"; ctx.fillRect(0, 0, 800, 1000);
            ctx.fillStyle = "#ffffff"; ctx.font = "bold 50px Arial"; ctx.textAlign = "center"; ctx.fillText("PENTAGON 5 VOL.2 2026", 400, 100);
            ctx.fillStyle = "#facc15"; ctx.font = "bold 40px Arial"; ctx.fillText(x.sekolah, 400, 250);
            let tempDiv = document.createElement('div'); new QRCode(tempDiv, { text: x.kode, width: 400, height: 400 });
            setTimeout(() => {
                const qrCanvas = tempDiv.querySelector('canvas'); 
                if(qrCanvas) ctx.drawImage(qrCanvas, 200, 325, 400, 400);
                ctx.fillStyle = "white"; ctx.font = "bold 60px Monospace"; ctx.fillText(x.kode, 400, 890);
                const imgUrl = canvas.toDataURL("image/png"); const link = document.createElement('a'); link.download = `ABSENSI_${x.sekolah}.png`; link.href = imgUrl; link.click();
                setupWA(id, 'qr'); 
            }, 500);
        }

        // --- UPDATE: SETUP WA PINTAR (HANYA YANG DICEKLIS) ---
        function setupWA(id, type = 'qr') {
            const x = db.find(d => d.id == id);
            if (!x) return;

            let phone = String(x.wa).replace(/\D/g,'');
            if(phone.startsWith('0')) phone = '62' + phone.slice(1);
            if(phone.startsWith('8')) phone = '628' + phone.slice(1);

            let msg = "";

            if (type === 'validation') {
                // LOGIKA: HANYA MELIST YANG DICEKLIS
                let listMataLomba = [];
                
                if(x.v_lkbbt)  listMataLomba.push(" LKBBT");
                if(x.v_maket)  listMataLomba.push(" MAKET PIONERING");
                if(x.v_dance)  listMataLomba.push(" SCOUT DANCE");
                if(x.v_ios)    listMataLomba.push(" IOS");
                if(x.v_poster) listMataLomba.push(" POSTER DESIGN");

                let listStr = listMataLomba.length > 0 ? listMataLomba.join("\n") : "(Belum ada mata lomba yang tervalidasi)";
                let statusFinal = x.v_status || "BELUM LENGKAP";
                
                if (statusFinal === 'LENGKAP') {
                    // PESAN JIKA STATUS SUDAH LENGKAP (PARTIAL PARTICIPATION)
                    msg = `*VALIDASI BERKAS*\n` +
                          `*PENTAGON 5 VOL.2 2026*\n\n` +
                          `Halo Official *${x.sekolah}*,\n\n` +
                          `Panitia telah memvalidasi berkas pendaftaran tim kakak.\n` +
                          `Berikut adalah daftar mata lomba yang terkonfirmasi diikuti:\n\n` +
                          `${listStr}\n\n` +
                          `Status Administrasi: *LENGKAP* \n` +
                          `Data sudah kami kunci. Sampai jumpa di hari perlombaan!\n\n` +
                          `_ Admin Pentagon 5_`;

                } else {
                    // PESAN KONFIRMASI (JIKA MASIH ADA YANG KURANG / RAGU)
                    let note = x.v_note ? `\n\n *Catatan Admin:* "${x.v_note}"` : "";

                    msg = ` *KONFIRMASI VALIDASI BERKAS*\n` +
                          `*PENTAGON 5 VOL.2 2026*\n\n` +
                          `Halo Official *${x.sekolah}*,\n` +
                          `Saat ini kami baru menerima/memvalidasi berkas untuk mata lomba berikut:\n\n` +
                          `${listStr}\n\n` +
                          `Status saat ini: *${statusFinal}*\n` +
                          `${note}\n` +
                          `Jika kakak mengikuti mata lomba lain namun belum tercantum di atas, mohon segera kirim berkasnya. Jika sudah sesuai, abaikan pesan ini.\n\n` +
                          `Terima kasih! `;
                }

            } else {
                msg = `*PENTAGON 5 VOL.2 2026*\n\n` +
                      `Halo Official *${x.sekolah}*,\n` +
                      `Berikut adalah QR untuk Absensi.\n\n` +
                      ` Sekolah: *${x.sekolah}*\n` +
                      ` No. Tampil: *${x.tampil}*\n\n` +
                      `Mohon simpan gambar QR Code di atas untuk scan kehadiran saat masuk.`;
            }

            document.getElementById('wa-num').value = phone;
            document.getElementById('wa-msg').value = msg;
            
            document.getElementById('btn-open-wa-manual').href = `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(msg)}`;
            
            openModal('modal-wa');
        }

        function copyInput(id) {
            const el = document.getElementById(id); el.select(); navigator.clipboard.writeText(el.value); toast("Disalin!");
        }

        function toast(msg, type='success') { 
            const box = document.getElementById('toast-box'); const el = document.createElement('div');
            el.className = 'toast-item'; el.style.borderLeftColor = type==='success'?'#22c55e':'#ef4444';
            el.innerHTML = `<b>${msg}</b>`; box.appendChild(el); setTimeout(()=>el.remove(), 3000);
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>

