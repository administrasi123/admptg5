<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PENTAGON 5 VOL.2 2026 - LOGIN</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --sidebar-bg: #0f172a; --active-blue: #3b82f6; --body-bg: #f1f5f9; }
        body { background-color: var(--body-bg); font-family: 'Poppins', sans-serif; overflow-x: hidden; color: #334155; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* SIDEBAR */
        .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); color: white; position: fixed; padding: 30px 20px; display: flex; flex-direction: column; z-index: 1000; transition: all 0.3s ease; }
        .nav-btn { padding: 12px 20px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; color: #94a3b8; font-weight: 600; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--active-blue); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--sidebar-bg); color: white; padding: 10px 14px; border-radius: 8px; border: none; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; padding: 30px 40px; min-height: 100vh; filter: blur(5px); transition: filter 0.3s; pointer-events: none; } /* Blur default sebelum login */
        .main-content.logged-in { filter: none; pointer-events: auto; }
        
        .white-panel { background: white; border-radius: 20px; padding: 30px; min-height: 600px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .view-section { display: none; } .view-section.active { display: block; }

        /* STATS */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { border-radius: 15px; padding: 20px; color: white; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .bg-1 { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-2 { background: linear-gradient(135deg, #f43f5e, #e11d48); }
        .bg-3 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-4 { background: linear-gradient(135deg, #f97316, #ea580c); }

        /* CHECKBOX CUSTOM */
        .chk-container { display: flex; flex-direction: column; align-items: center; margin: 0 2px; }
        .chk-title { font-size: 0.55rem; font-weight: bold; color: #64748b; margin-bottom: 2px; }
        .custom-chk { display: none; }
        .chk-label { width: 28px; height: 28px; background: #e2e8f0; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: transparent; transition: 0.2s; }
        .custom-chk:checked + .chk-label { background: #10b981; color: white; transform: scale(1.1); }
        
        /* TOAST & LOADER */
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast-item { background: white; padding: 15px 20px; border-radius: 10px; border-left: 5px solid #3b82f6; box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-content-box { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popUp 0.3s; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .tab-btn { padding: 8px 20px; border-radius: 20px; border: none; background: #e2e8f0; color: #64748b; font-weight: 600; margin-right: 5px; font-size: 0.9rem; }
        .tab-btn.active-smp { background: #dbeafe; color: #1e40af; }
        .tab-btn.active-sma { background: #fee2e2; color: #991b1b; }

        /* SCANNER FIX (NO MIRROR) */
        #qr-reader { width: 100%; border-radius: 10px; overflow: hidden; border: 2px solid #e2e8f0; }
        #qr-reader video { transform: scaleX(1) !important; object-fit: cover !important; }
        #qr-display { display: flex; justify-content: center; padding: 20px; background: white; }
        #qr-display img { border: 5px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* --- LOGIN STYLES --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 999999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px;
            width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .login-hidden { display: none !important; }

        @media (max-width: 768px) {
            .sidebar { left: -270px; } .sidebar.active { left: 0; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            .main-content { margin-left: 0; padding: 80px 15px 30px 15px; }
            .mobile-toggle { display: block; }
            .stats-row { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-card h6 { font-size: 0.7rem; } .stat-card h2 { font-size: 1.5rem; }
            .white-panel { padding: 15px; min-height: auto; }
            #cari-sekolah { width: 100% !important; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card fade-in">
            <div class="mb-4">
                <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
                <h4 class="fw-bold mt-2">Halo, Selamat Datang!</h4>
                <p class="text-secondary small">Admin PENTAGON 5 VOL.2 2026</p>
            </div>
            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="form-floating mb-3">
                    <input type="password" class="form-control text-center fw-bold" id="password-input" placeholder="Password" style="letter-spacing: 5px;">
                    <label for="password-input">Masukkan Kode Akses</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold rounded-pill shadow-sm">LOG-IN</button>
            </form>
            <div class="mt-4 small text-muted">
                &copy; ADMINISTRASI PENTAGON VOL.2 2026
            </div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="fw-bold small text-secondary">MEMUAT SISTEM PENTAGON...</div>
    </div>
    <div id="toast-box"></div>
    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="bi bi-list fs-4"></i></button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="text-center mb-5 mt-2">
            <h4 class="fw-bold mb-0 text-light">PENTAGON 5</h4>
            <small class="text-white-50" style="letter-spacing: 2px;">VOL. 2 2026</small>
        </div>
        <div class="nav-btn active" id="btn-dash" onclick="switchView('dash')"><i class="bi bi-grid-fill"></i> DASHBOARD</div>
        <div class="nav-btn" id="btn-input" onclick="switchView('input')"><i class="bi bi-people-fill"></i> DATA PESERTA</div>
        <div class="nav-btn" id="btn-validasi" onclick="switchView('validasi')"><i class="bi bi-check-circle-fill"></i> VALIDASI BERKAS</div>
        <div class="nav-btn" id="btn-absensi" onclick="switchView('absensi')"><i class="bi bi-qr-code-scan"></i> ABSENSI</div>
        <button class="nav-btn mt-auto btn-danger border-0 text-start w-100" onclick="logoutSystem()">
            <i class="bi bi-box-arrow-left"></i> LOGOUT
        </button>
    </div>

    <div class="main-content">
        <div class="stats-row">
            <div class="stat-card bg-1">
                <h6>BELUM HADIR (<span id="lbl-tab">SMP</span>)</h6>
                <h2 id="st-total">0</h2>
            </div>
            <div class="stat-card bg-2"><h6>DATA LENGKAP</h6><h2 id="st-com">0</h2></div>
            <div class="stat-card bg-3"><h6>SUDAH UNDIAN</h6><h2 id="st-und">0</h2></div>
            <div class="stat-card bg-4"><h6>SUDAH HADIR</h6><h2 id="st-absen">0</h2></div>
        </div>

        <div class="white-panel">
            
            <div id="view-dash" class="view-section active text-center pt-3">
                <div class="py-5">
                    <i class="bi bi-shield-lock-fill text-primary" style="font-size: 60px;"></i>
                    <h3 class="fw-bold mt-3">ADMIN CENTER</h3>
                    <p class="text-secondary small mb-4">PENTAGON 5 VOL.2 2026</p>
                    <div class="d-grid gap-2 col-lg-6 mx-auto">
                        <button class="btn btn-primary rounded-pill shadow-sm py-2" onclick="switchView('input')">INPUT DATA</button>
                        <button class="btn btn-dark rounded-pill shadow-sm py-2" onclick="switchView('absensi')"><i class="bi bi-qr-code"></i> SCAN ABSENSI</button>
                    </div>
                </div>
            </div>

            <div id="view-input" class="view-section">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h5 class="fw-bold m-0"><i class="bi bi-table text-primary"></i> DATA PESERTA</h5>
                    <button class="btn btn-primary btn-sm rounded-pill shadow-sm px-3" onclick="tambahPeserta()"><i class="bi bi-plus-lg"></i> TAMBAH</button>
                </div>
                
                <div class="row g-2 mb-2">
                    <div class="col-12 col-md-4">
                        <div class="d-flex gap-1">
                            <button class="tab-btn active-smp" id="tab-in-smp" onclick="setTab('SMP')">SMP</button>
                            <button class="tab-btn" id="tab-in-sma" onclick="setTab('SMA')">SMA</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-8">
                        <input type="text" id="cari-sekolah" class="form-control" placeholder="Cari Sekolah / Kode..." onkeyup="renderAll()">
                    </div>
                </div>

                <div class="d-flex align-items-center justify-content-between mb-3 bg-light p-2 rounded">
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" id="chk-hide-absen" onchange="renderAll()" checked>
                        <label class="form-check-label small fw-bold text-secondary" for="chk-hide-absen">Sembunyikan Yang Sudah Hadir</label>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-success btn-sm fw-bold" onclick="exportExcel()"><i class="bi bi-file-excel"></i></button>
                        <button class="btn btn-danger btn-sm fw-bold" onclick="exportPDFList()"><i class="bi bi-file-pdf"></i></button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle" style="min-width: 600px;">
                        <thead class="table-light small"><tr><th>SEKOLAH</th><th class="text-center">UNDIAN</th><th>KODE</th><th class="text-center">AKSI</th></tr></thead>
                        <tbody id="body-input" class="small"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-validasi" class="view-section">
                <div class="d-flex justify-content-between mb-4 align-items-center">
                    <h5 class="fw-bold m-0 text-primary"><i class="bi bi-patch-check-fill"></i> VALIDASI</h5>
                    <button class="btn btn-danger btn-sm fw-bold shadow-sm" onclick="exportPDFRekap()"><i class="bi bi-printer-fill"></i> REKAP</button>
                </div>
                <div class="mb-3">
                    <button class="tab-btn active-smp" id="tab-val-smp" onclick="setTab('SMP')">SMP</button>
                    <button class="tab-btn" id="tab-val-sma" onclick="setTab('SMA')">SMA</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle border" style="min-width: 700px;">
                        <thead class="table-dark small">
                            <tr>
                                <th width="25%">SEKOLAH</th><th width="35%" class="text-center">KELENGKAPAN</th>
                                <th width="20%">CATATAN</th><th width="10%" class="text-center">STATUS</th><th width="10%" class="text-center">AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="body-validasi" class="small"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-absensi" class="view-section">
                <div class="row">
                    <div class="col-md-5 mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-camera-video-fill text-primary"></i> SCANNER</h5>
                        
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-primary btn-sm flex-fill shadow-sm" onclick="startScanner()" id="btn-start-cam">
                                <i class="bi bi-power"></i> ON
                            </button>
                            <button class="btn btn-danger btn-sm flex-fill shadow-sm" onclick="stopScanner()" id="btn-stop-cam" disabled>
                                <i class="bi bi-stop-circle"></i> OFF
                            </button>
                            <button class="btn btn-warning btn-sm shadow-sm" onclick="restartScanner()" title="Fokus Ulang">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </div>

                        <div id="qr-reader" class="mb-3 shadow-sm border bg-dark" style="min-height: 250px; background: #000;"></div>
                        <div class="alert alert-info small"><i class="bi bi-info-circle"></i> Jika buram, tekan tombol kuning untuk <b>Fokus Ulang</b>.</div>
                    </div>

                    <div class="col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold m-0">RIWAYAT SCAN</h5>
                            <button class="btn btn-outline-danger btn-sm" onclick="resetAbsenHarian()">Reset Harian</button>
                        </div>
                        <div class="table-responsive border rounded p-2" style="height: 400px; overflow-y: auto; background: #f8fafc;">
                            <table class="table table-sm table-striped small align-middle">
                                <thead class="table-dark"><tr><th>WAKTU</th><th>SEKOLAH</th><th>STATUS</th><th class="text-center">AKSI</th></tr></thead>
                                <tbody id="log-absen-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="modal-input">
        <div class="modal-content-box">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold">FORMULIR PESERTA <span id="lbl-form-tingkat" class="badge bg-primary"></span></h5>
                <button class="btn-close" onclick="closeModal('modal-input')"></button>
            </div>
            <form id="form-peserta">
                <input type="hidden" id="in-tingkat">
                <div class="mb-2"><label class="small fw-bold text-secondary">NAMA SEKOLAH</label><input type="text" id="in-sekolah" class="form-control" placeholder="Contoh: SMPN 1 BEKASI" required></div>
                <div class="mb-2"><label class="small fw-bold text-secondary">EMAIL OFFICIAL</label><input type="email" id="in-email" class="form-control" placeholder="email@sekolah.com"></div>
                <div class="mb-2"><label class="small fw-bold text-secondary">WHATSAPP</label><input type="tel" id="in-wa" class="form-control" placeholder="08xxx" required></div>
                <div class="mb-4"><label class="small fw-bold text-secondary">BINDAMPING</label><input type="text" id="in-b1" class="form-control mb-1" placeholder="Nama B1"><input type="text" id="in-b2" class="form-control" placeholder="Nama B2"></div>
                <button type="submit" class="btn btn-primary w-100 fw-bold py-2">SIMPAN DATA</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-show-qr">
        <div class="modal-content-box text-center">
            <h5 class="fw-bold mb-1" id="qr-title">SEKOLAH</h5>
            <p class="text-muted small mb-3" id="qr-sub">KODE</p>
            <div id="qr-display" class="mb-3"></div> 
            <button class="btn btn-primary w-100 mb-2 fw-bold" onclick="downloadQR()"><i class="bi bi-download"></i> DOWNLOAD GAMBAR</button>
            <button class="btn btn-outline-secondary w-100" onclick="closeModal('modal-show-qr')">TUTUP</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-wa">
        <div class="modal-content-box bg-success-subtle">
            <div class="d-flex justify-content-between mb-3 text-success">
                <h5 class="fw-bold"><i class="bi bi-whatsapp"></i> PREVIEW PESAN</h5>
                <button class="btn-close" onclick="closeModal('modal-wa')"></button>
            </div>
            <div class="mb-2"><label class="small fw-bold text-secondary">NOMOR TUJUAN</label><input type="text" id="wa-num" class="form-control fw-bold border-success"></div>
            <div class="mb-3"><label class="small fw-bold text-secondary">ISI PESAN</label><textarea id="wa-msg" class="form-control border-success" rows="6"></textarea></div>
            <button onclick="kirimWA()" class="btn btn-success w-100 fw-bold"><i class="bi bi-send-fill"></i> KIRIM SEKARANG</button>
        </div>
    </div>

    <script>
        // KONFIGURASI LOGIN
        const APP_PASSWORD = "admin123"; // GANTI PASSWORD DI SINI
        const API_URL = "https://script.google.com/macros/s/AKfycbxLGPFwQf_sATouSMQPzHJkBdQpLONbmVXMCiAMRvT9yFDitHEZ8OmJhKCIaC7K7GUV/exec"; 
        
        let db = [];
        let html5QrcodeScanner = null;
        let currentTab = 'SMP';

        window.onload = function() {
            // Check Session Login
            const isLogged = sessionStorage.getItem('ptg_login');
            if(isLogged === 'true') {
                document.getElementById('login-overlay').classList.add('login-hidden');
                document.querySelector('.main-content').classList.add('logged-in');
            } else {
                document.getElementById('loader').style.display = 'none'; // Sembunyikan loader kalau belum login agar form login terlihat
            }
            
            // Load Data Background (tetap load data agar saat login sudah siap)
            if(API_URL.includes("GANTI")) {
                db = [
                    {id:1, sekolah:"SMPN 1 CONTOH", tingkat:"SMP", wa:"08123456789", kode:"PTG-G-001", tampil:"1", v_status:"BELUM LENGKAP", absen: false},
                    {id:2, sekolah:"SMAN 2 CONTOH", tingkat:"SMA", wa:"08129876543", kode:"PTG-T-005", tampil:"5", v_status:"LENGKAP", absen: false}
                ];
                renderAll(); updateStats(); 
                if(isLogged === 'true') document.getElementById('loader').style.display = 'none';
            } else {
                fetchData();
            }
        };

        function handleLogin(e) {
            e.preventDefault();
            const input = document.getElementById('password-input').value;
            if(input === APP_PASSWORD) {
                sessionStorage.setItem('ptg_login', 'true');
                document.getElementById('login-overlay').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('login-overlay').classList.add('login-hidden');
                    document.querySelector('.main-content').classList.add('logged-in');
                    document.getElementById('loader').style.display = 'none';
                    toast("Berhasil Login Admin", "success");
                }, 500);
            } else {
                alert("PASSWORD SALAH!");
                document.getElementById('password-input').value = '';
            }
        }

        function logoutSystem() {
            sessionStorage.removeItem('ptg_login');
            location.reload();
        }

        async function fetchData() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                db = json.data || json;
                db.forEach(x => { if(typeof x.absen === 'undefined') x.absen = false; });
                renderAll(); updateStats();
                // Hanya hilangkan loader jika sudah login, jika belum biarkan tertutup login screen
                if(sessionStorage.getItem('ptg_login') === 'true') {
                    document.getElementById('loader').style.display = 'none';
                    toast("Data Berhasil Dimuat");
                }
            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                if(sessionStorage.getItem('ptg_login') === 'true') toast("Gagal Koneksi Server", "danger");
            }
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').style.display = 
                document.querySelector('.sidebar').classList.contains('active') ? 'block' : 'none';
        }

        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.getElementById('btn-'+v).classList.add('active');
            if(window.innerWidth <= 768) toggleSidebar();
            if(v !== 'absensi') stopScanner();
            renderAll();
        }

        function setTab(t) {
            currentTab = t;
            ['tab-in-smp', 'tab-in-sma', 'tab-val-smp', 'tab-val-sma'].forEach(id => {
                const el = document.getElementById(id);
                el.className = 'tab-btn';
                if(id.includes(t.toLowerCase())) el.className = t === 'SMP' ? 'tab-btn active-smp' : 'tab-btn active-sma';
            });
            renderAll();
        }

        function tambahPeserta() {
            document.getElementById('in-tingkat').value = currentTab;
            document.getElementById('lbl-form-tingkat').innerText = currentTab; 
            openModal('modal-input');
        }

        function updateStats() { 
            if(!db) return;
            document.getElementById('lbl-tab').innerText = currentTab;
            const list = db.filter(x => x.tingkat === currentTab);
            const sisa = list.filter(x => !x.absen).length;
            const lengkap = list.filter(x => x.v_status === 'LENGKAP').length;
            const undian = list.filter(x => x.tampil !== '-' && x.tampil).length;
            const hadir = list.filter(x => x.absen).length;
            document.getElementById('st-total').innerText = sisa;
            document.getElementById('st-com').innerText = lengkap; 
            document.getElementById('st-und').innerText = undian; 
            document.getElementById('st-absen').innerText = hadir; 
        }

        function renderAll() { renderTableInput(); renderTableValidasi(); updateStats(); }

        function renderTableInput() {
            const tbody = document.getElementById('body-input'); tbody.innerHTML = '';
            const key = document.getElementById('cari-sekolah').value.toUpperCase();
            
            const hideAbsen = document.getElementById('chk-hide-absen').checked;
            
            let list = db.filter(x => x.tingkat === currentTab && 
                (!hideAbsen || !x.absen) && 
                (x.sekolah.toUpperCase().includes(key) || (x.kode && x.kode.toUpperCase().includes(key))));
            
            list.sort((a, b) => {
                const valA = (a.tampil === '-' || !a.tampil) ? Infinity : parseInt(a.tampil);
                const valB = (b.tampil === '-' || !b.tampil) ? Infinity : parseInt(b.tampil);
                if (valA === valB) return a.sekolah.localeCompare(b.sekolah);
                return valA - valB;
            });

            if(list.length === 0) {
                const totalDataReal = db.filter(x => x.tingkat === currentTab).length;
                if(totalDataReal === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted bg-light"><i class="bi bi-inbox fs-1 d-block mb-2 text-secondary"></i>Data Peserta Kosong / Belum Diinput</td></tr>`;
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted bg-light"><i class="bi bi-check-circle-fill text-success fs-1 d-block mb-2"></i>Semua Peserta ${currentTab} Sudah Hadir!</td></tr>`; 
                }
                return; 
            }

            list.forEach(x => {
                const rowClass = x.absen ? 'table-success fade-in' : 'fade-in';
                const statusBadge = x.absen ? '<span class="badge bg-success"><i class="bi bi-check"></i> HADIR</span>' : '';

                tbody.innerHTML += `
                <tr class="${rowClass}">
                    <td class="fw-bold text-nowrap">
                        ${x.sekolah}
                        <div class="small">${statusBadge}</div>
                    </td>
                    <td class="text-center"><span class="badge ${x.tampil==='-'?'bg-secondary':'bg-primary'}">${x.tampil}</span></td>
                    <td class="small font-monospace text-nowrap">${x.kode||'-'}</td>
                    <td class="text-center text-nowrap">
                        <button class="btn btn-sm btn-dark" onclick="showQR(${x.id})" title="Lihat QR"><i class="bi bi-qr-code"></i></button>
                        <button class="btn btn-sm btn-success" onclick="kirimInfoPeserta(${x.id})" title="Kirim WA & ID Card"><i class="bi bi-whatsapp"></i></button>
                        <button onclick="editUndian(${x.id})" class="btn btn-sm btn-outline-primary rounded-circle"><i class="bi bi-pencil"></i></button>
                        <button onclick="hapusData(${x.id})" class="btn btn-sm btn-outline-danger rounded-circle"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function renderTableValidasi() {
            const tbody = document.getElementById('body-validasi'); tbody.innerHTML = '';
            const list = db.filter(x => x.tingkat === currentTab);
            
            list.forEach(x => {
                const badge = x.v_status === 'LENGKAP' ? 'bg-success' : 'bg-danger';
                const mkChk = (col, label) => `<div class="chk-container"><div class="chk-title">${label}</div><input type="checkbox" id="${col}_${x.id}" class="custom-chk" ${x['v_'+col]?'checked':''}><label for="${col}_${x.id}" class="chk-label"><i class="bi bi-check-lg"></i></label></div>`;
                
                tbody.innerHTML += `
                <tr class="fade-in">
                    <td class="fw-bold small text-nowrap">
                        ${x.sekolah}
                        <div class="mt-1">
                            <button onclick="cariDiDrive('${x.sekolah}')" class="btn btn-sm btn-warning text-dark py-0 px-2 shadow-sm" style="font-size: 0.7rem;" title="Cari Folder di Drive">
                                <i class="bi bi-search"></i> CARI BERKAS
                            </button>
                        </div>
                    </td>
                    <td><div class="d-flex justify-content-center gap-1">${mkChk('lkbbt','LKB')} ${mkChk('maket','MKT')} ${mkChk('dance','DNC')} ${mkChk('ios','IOS')} ${mkChk('poster','POS')}</div></td>
                    <td><input type="text" id="note_${x.id}" class="form-control form-control-sm" value="${x.v_note||'-'}" placeholder="-"></td>
                    <td class="text-center"><span class="badge ${badge} small">${x.v_status}</span></td>
                    <td class="text-center text-nowrap">
                        <div class="btn-group">
                            <button onclick="simpanValidasi(${x.id})" class="btn btn-sm btn-primary"><i class="bi bi-floppy"></i></button>
                            <button onclick="setupWA(${x.id})" class="btn btn-sm btn-success"><i class="bi bi-whatsapp"></i></button>
                            <button onclick="cetakSurat(${x.id})" class="btn btn-sm btn-danger"><i class="bi bi-file-pdf"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
        }

        function cariDiDrive(namaSekolah) {
            const parentID = "1nyDKvIUNTCuU7xuINVjojZ3gVjzZ76GYQ64HeCrwNFgAciJvRK-JD3UN-YBSMlETRzcP7617";
            const cleanName = namaSekolah.trim();
            const query = `parent:${parentID} "${cleanName}"`;
            const url = `https://drive.google.com/drive/search?q=${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }

        function startScanner() {
            if(html5QrcodeScanner) { toast("Kamera sudah aktif", "info"); return; }
            if(document.getElementById('btn-start-cam')) { document.getElementById('btn-start-cam').disabled = true; document.getElementById('btn-stop-cam').disabled = false; }
            html5QrcodeScanner = new Html5Qrcode("qr-reader");
            const config = { fps: 15, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0, videoConstraints: { facingMode: "environment", focusMode: "continuous", height: { min: 480, ideal: 720 } } };
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess).catch(err => { console.log(err); if(document.getElementById('btn-start-cam')) { document.getElementById('btn-start-cam').disabled = false; document.getElementById('btn-stop-cam').disabled = true; } toast("Gagal membuka kamera: " + err, "danger"); });
        }

        function stopScanner() {
            if(html5QrcodeScanner) { html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); html5QrcodeScanner = null; if(document.getElementById('btn-start-cam')) { document.getElementById('btn-start-cam').disabled = false; document.getElementById('btn-stop-cam').disabled = true; } }).catch(err => console.log("Stop failed", err)); }
        }

        function restartScanner() { if(html5QrcodeScanner) { stopScanner(); setTimeout(() => startScanner(), 500); toast("Me-refresh Lensa...", "info"); } else { startScanner(); } }

        function onScanSuccess(decodedText) {
            const cleanCode = decodedText.trim().toUpperCase();
            const idx = db.findIndex(x => x.kode === cleanCode);
            if(idx >= 0) {
                if(db[idx].absen) { toast(`${db[idx].sekolah} Sudah Absen!`, 'danger'); } else {
                    db[idx].absen = true; new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    toast(`${db[idx].sekolah} Hadir`, 'success');
                    addLogAbsen(db[idx].id, db[idx].sekolah, "BERHASIL");
                    renderTableInput(); updateStats();
                    if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'attendance', id:db[idx].id, status: true})});
                }
                html5QrcodeScanner.pause(2000); setTimeout(() => html5QrcodeScanner.resume(), 2000);
            } else { toast(`Kode ${cleanCode} Tidak Dikenal`, 'danger'); }
        }

        function addLogAbsen(id, nama, status) {
            const tbody = document.getElementById('log-absen-body'); 
            const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            const rowId = `log_${Date.now()}`;
            const rowHTML = `<tr id="${rowId}"><td>${now}</td><td class="fw-bold">${nama}</td><td class="status-cell"><span class="badge bg-success">${status}</span></td><td class="text-center"><button class="btn btn-sm btn-outline-danger py-0" onclick="batalAbsen(${id}, '${rowId}')" title="Batalkan Absen"><i class="bi bi-x-lg"></i> Batal</button></td></tr>`;
            tbody.insertAdjacentHTML('afterbegin', rowHTML);
        }

        function batalAbsen(id, rowElemId) {
            if(!confirm("Batalkan kehadiran peserta ini?")) return;
            const idx = db.findIndex(x => x.id == id);
            if(idx >= 0) {
                db[idx].absen = false; renderTableInput(); updateStats();
                const row = document.getElementById(rowElemId); if(row) { row.querySelector('.status-cell').innerHTML = '<span class="badge bg-secondary">DIBATALKAN</span>'; const btn = row.querySelector('button'); if(btn) btn.remove(); }
                toast(`${db[idx].sekolah} Absen Dibatalkan`, 'warning');
                if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'attendance', id:id, status: false})});
            }
        }
        function resetAbsenHarian() { if(confirm("Reset log?")) document.getElementById('log-absen-body').innerHTML = ''; }

        document.getElementById('form-peserta').addEventListener('submit', function(e){
            e.preventDefault();
            const newData = {
                action: 'add', id: Date.now(),
                sekolah: document.getElementById('in-sekolah').value.toUpperCase(),
                email: document.getElementById('in-email').value,
                tingkat: document.getElementById('in-tingkat').value,
                wa: document.getElementById('in-wa').value,
                b1: document.getElementById('in-b1').value, b2: document.getElementById('in-b2').value,
                tampil:'-', kode:'-', v_lkbbt:0, v_maket:0, v_dance:0, v_ios:0, v_poster:0, v_note:'-', v_status:'BELUM LENGKAP', absen: false
            };
            db.push(newData); closeModal('modal-input'); renderAll(); toast("Data Disimpan Lokal");
            if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(newData)});
            this.reset();
        });

        function simpanValidasi(id) {
            const idx = db.findIndex(x => x.id == id); const cols = ['lkbbt','maket','dance','ios','poster']; let complete = true;
            cols.forEach(c => { const val = document.getElementById(`${c}_${id}`).checked ? 1 : 0; db[idx]['v_'+c] = val; if(!val) complete = false; });
            db[idx].v_note = document.getElementById(`note_${id}`).value; db[idx].v_status = complete ? 'LENGKAP' : 'BELUM LENGKAP';
            renderTableValidasi(); updateStats(); toast("Validasi Tersimpan");
            if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'validate', id:id, ...db[idx]})});
        }
        function editUndian(id) {
            const val = prompt("Masukkan No Undian:");
            if(val) {
                const idx = db.findIndex(x => x.id == id); db[idx].tampil = val; db[idx].kode = `PTG-${db[idx].tingkat==='SMP'?'G':'T'}-${val.padStart(3,'0')}`;
                renderAll(); updateStats(); toast("No Undian Diupdate");
                if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'edit', id:id, tampil:val, kode:db[idx].kode})});
            }
        }
        function hapusData(id) { if(confirm("Yakin hapus?")) { db = db.filter(x => x.id != id); renderAll(); updateStats(); if(!API_URL.includes("GANTI")) fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'delete', id:id})}); } }

        function showQR(id) {
            const x = db.find(d => d.id == id); if(!x || !x.kode || x.kode === '-') { alert("Peserta belum memiliki Kode!"); return; }
            document.getElementById('qr-title').innerText = x.sekolah; document.getElementById('qr-sub').innerText = x.kode;
            const container = document.getElementById('qr-display'); container.innerHTML = '';
            new QRCode(container, { text: x.kode, width: 200, height: 200, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            openModal('modal-show-qr');
        }
        function downloadQR() {
            const container = document.getElementById('qr-display'); const img = container.querySelector('img'); let url = "";
            if (img && img.src) url = img.src; else { const canvas = container.querySelector('canvas'); if(canvas) url = canvas.toDataURL("image/png"); }
            if(url) { const link = document.createElement('a'); link.download = `QR_${document.getElementById('qr-title').innerText}.png`; link.href = url; link.click(); }
        }
        function kirimInfoPeserta(id) {
            const x = db.find(d => d.id == id); if(!x) return; toast("Mendesain ID Card & Membuka WA...", "info");
            const canvas = document.createElement('canvas'); canvas.width = 800; canvas.height = 1000; const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 1000); gradient.addColorStop(0, "#0f172a"); gradient.addColorStop(1, "#1e293b"); ctx.fillStyle = gradient; ctx.fillRect(0, 0, 800, 1000);
            ctx.beginPath(); ctx.arc(400, -100, 600, 0, 2 * Math.PI); ctx.fillStyle = "rgba(59, 130, 246, 0.1)"; ctx.fill();
            ctx.fillStyle = "#ffffff"; ctx.font = "bold 50px Arial"; ctx.textAlign = "center"; ctx.fillText("PENTAGON 5 VOL.2 2026", 400, 100);
            ctx.fillStyle = "#94a3b8"; ctx.font = "30px Arial"; ctx.fillText("KARTU ABSENSI BINDAMPING", 400, 150);
            ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=10; ctx.fillStyle = "#facc15"; let fontSize = 45; if(x.sekolah.length > 20) fontSize = 35; ctx.font = `bold ${fontSize}px Arial`; ctx.fillText(x.sekolah, 400, 250); ctx.shadowBlur=0;
            let tempDiv = document.createElement('div'); new QRCode(tempDiv, { text: x.kode, width: 400, height: 400, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            setTimeout(() => {
                const qrCanvas = tempDiv.querySelector('canvas'); ctx.fillStyle = "white"; ctx.fillRect(175, 300, 450, 450); if(qrCanvas) ctx.drawImage(qrCanvas, 200, 325, 400, 400);
                ctx.fillStyle = "white"; ctx.font = "30px Arial"; ctx.fillText("NOMOR PESERTA:", 400, 820); ctx.fillStyle = "#3b82f6"; ctx.font = "bold 60px Monospace"; ctx.fillText(x.kode, 400, 890); ctx.fillStyle = "white"; ctx.font = "bold 25px Arial"; ctx.fillText(`NO. TAMPIL: ${x.tampil}`, 400, 950);
                const imgUrl = canvas.toDataURL("image/png"); const link = document.createElement('a'); link.download = `ABSENSI BINDAMPING${x.sekolah.replace(/\s+/g, '_')}.png`; link.href = imgUrl; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                let num = cleanNum(x.wa); const msg = `*OFFICIAL PENTAGON 5 VOL.2*\n\nHalo, *${x.sekolah}*!\n\nBerikut kami lampirkan *KARTU ABSENSI BINDAMPING*.\n\nNomor Peserta: ${x.kode}`;
                setTimeout(() => { window.open(`https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(msg)}`, '_blank'); toast("ID Card Terdownload! Kirim via WA.", "success"); }, 800);
            }, 500);
        }
        function setupWA(id) { const x = db.find(d => d.id == id); let num = cleanNum(x.wa); const v = "✅"; const z = "❌"; const msg = `*INFO PENTAGON 5 VOL.2*\nHalo! ${x.sekolah}\n\nStatus berkas:\nLKBBT: ${x.v_lkbbt?v:z}\nMaket: ${x.v_maket?v:z}\nDance: ${x.v_dance?v:z}\nIOS: ${x.v_ios?v:z}\nPoster: ${x.v_poster?v:z}\n\nCatatan: ${x.v_note}\n\nTerima kasih!`; document.getElementById('wa-num').value = num; document.getElementById('wa-msg').value = msg; openModal('modal-wa'); }
        function kirimWA() { window.open(`https://api.whatsapp.com/send?phone=${document.getElementById('wa-num').value}&text=${encodeURIComponent(document.getElementById('wa-msg').value)}`, '_blank'); closeModal('modal-wa'); }
        function cleanNum(n) { let num = String(n).replace(/\D/g,''); if(num.startsWith('0')) num = '62' + num.substring(1); if(num.startsWith('8')) num = '62' + num; return num; }
        
        function exportPDFList() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let list = db.filter(x => x.tingkat === currentTab); list.sort((a,b)=> { const vA = (a.tampil==='-'?!1:parseInt(a.tampil))||999; const vB = (b.tampil==='-'?!1:parseInt(b.tampil))||999; return vA - vB; }); doc.text(`DATA ${currentTab}`,14,20); doc.autoTable({startY:30, head:[['No','Sekolah','Undian','Kode']], body:list.map((x,i)=>[i+1,x.sekolah,x.tampil,x.kode])}); doc.save('Peserta.pdf'); }
        function exportPDFRekap() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let list = db.filter(x => x.tingkat === currentTab); doc.text(`REKAP ${currentTab}`,14,20); doc.autoTable({startY:30,head:[['Sekolah','L','M','D','I','P','Status']],body:list.map(x=>[x.sekolah,x.v_lkbbt?'V':'-',x.v_maket?'V':'-',x.v_dance?'V':'-',x.v_ios?'V':'-',x.v_poster?'V':'-',x.v_status])}); doc.save('Rekap.pdf'); }
        function exportExcel() { const list = db.filter(x => x.tingkat === currentTab); const ws = XLSX.utils.json_to_sheet(list.map((x,i)=>({No:i+1, Sekolah:x.sekolah, Undian:x.tampil, Kode:x.kode, Status:x.v_status}))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "Data.xlsx"); }
        function cetakSurat(id) {
    const x = db.find(d => d.id == id);
    if (!x) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;

    // --- 1. HEADER DARK BLUE ---
    doc.setFillColor(15, 23, 42); // WARNA NAVY SEPERTI DI GAMBAR
    doc.rect(0, 0, pageWidth, 45, 'F'); // KOTAK HEADER FULL WIDTH

    // JUDUL UTAMA
    doc.setTextColor(255, 255, 255); // WARNA PUTIH
    doc.setFont("helvetica", "normal");
    doc.setFontSize(16);
    doc.text("LEMBAR VALIDASI PESERTA", pageWidth / 2, 20, { align: "center" });

    // SUB-JUDUL
    doc.setFontSize(10);
    doc.text("PENTAGON VOL.2 - SCOUT COMPETITION", pageWidth / 2, 28, { align: "center" });

    // --- 2. INFORMASI SEKOLAH ---
    doc.setTextColor(0, 0, 0); // KEMBALI KE HITAM
    doc.setFontSize(11);
    
    let infoY = 65; // POSISI Y UNTUK INFO SEKOLAH
    const lineHeight = 8;

    doc.text(`Sekolah : ${x.sekolah}`, 20, infoY);
    doc.text(`Tingkat : ${x.tingkat}`, 20, infoY + lineHeight);
    doc.text(`Kode    : ${x.kode || '-'}`, 20, infoY + (lineHeight * 2));

    // --- 3. STATUS STAMP (KANAN ATAS) ---
    doc.setFont("helvetica", "normal");
    doc.setFontSize(14);
    
    if (x.v_status === 'LENGKAP') {
        doc.setTextColor(22, 163, 74); // HIJAU
        doc.text("LENGKAP", pageWidth - 20, infoY + 5, { align: "right" });
    } else {
        doc.setTextColor(220, 38, 38); // MERAH
        doc.text("BELUM LENGKAP", pageWidth - 20, infoY + 5, { align: "right" });
    }

    // --- 4. DATA TABEL ---
    // HELPER UNTUK MENGUBAH 1/0 JADI TEKS
    const cek = (val) => val ? "LENGKAP" : "BELUM ADA";

    const tableBody = [
        ["Formulir LKBBT", cek(x.v_lkbbt)],
        ["Maket Pionering", cek(x.v_maket)],
        ["Scout Dance", cek(x.v_dance)],
        ["Intelegent of Scout", cek(x.v_ios)],
        ["Desain Poster", cek(x.v_poster)]
    ];

    doc.autoTable({
        startY: infoY + 35,
        head: [['JENIS ADMINISTRASI', 'STATUS KELENGKAPAN']],
        body: tableBody,
        theme: 'grid', // AGAR ADA GARIS KOTAK-KOTAK
        styles: {
            fontSize: 10,
            cellPadding: 3,
            textColor: [60, 60, 60]
        },
        headStyles: {
            fillColor: [15, 23, 42], // WARNA HEADER TABEL NAVY
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            halign: 'left'
        },
        columnStyles: {
            0: { cellWidth: 100 }, // KOLOM KIRI LEBIH LEBAR
            1: { cellWidth: 'auto' }
        },
        margin: { left: 20, right: 20 }
    });

    // --- 5. CATATAN PANITIA ---
    let noteY = doc.lastAutoTable.finalY + 15;
    
    doc.setTextColor(0, 0, 0);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text("Catatan Panitia:", 20, noteY);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    // TEXT WRAP AGAR CATATAN TIDAK KELUAR BATAS
    const splitNote = doc.splitTextToSize(x.v_note || "-", pageWidth - 40);
    doc.text(splitNote, 20, noteY + 8);

    doc.save(`VALIDASI_${x.sekolah}.pdf`);
}

        function toast(msg, type='success') { const box = document.getElementById('toast-box'); const el = document.createElement('div'); el.className = 'toast-item'; el.style.borderLeftColor = type==='success'?'#22c55e':'#ef4444'; el.innerHTML = `<b>${msg}</b>`; box.appendChild(el); setTimeout(()=>el.remove(), 3000); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; } function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>